# TLSF (Two-Level Segregate Fit) memory allocator for TinyGo/Go


```text

 Allocator
 === The TLSF (Two-Level Segregate Fit) memory allocator ===
 see: http:www.gii.upv.es/tlsf/

 - `ffs(x)` is equivalent to `ctz(x)` with x != 0
 - `fls(x)` is equivalent to `sizeof(x) * 8 - clz(x) - 1`

 ╒══════════════ Block size interpretation (32-bit) ═════════════╕
    3                   2                   1
  1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0  bits
 ├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┼─┴─┴─┴─╫─┴─┴─┴─┤
 │ |                    FL                       │ SB = SL + AL  │ ◄─ usize
 └───────────────────────────────────────────────┴───────╨───────┘
 FL: first level, SL: second level, AL: alignment, SB: small block


 Memory manager

 ╒════════════ Memory manager block layout (32-bit) ═════════════╕
    3                   2                   1
  1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0  bits
 ├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┤
 │                           MM info                             │ -4
 ╞>ptr═══════════════════════════════════════════════════════════╡
 │                              ...                              │


 ╒════════════════════ Block layout (32-bit) ════════════════════╕
    3                   2                   1
  1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0  bits
 ├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┼─┼─┤            ┐
 │                          size                             │L│F│ ◄─┐ info   overhead
 ╞>ptr═══════════════════════════════════════════════════════╧═╧═╡   │        ┘
 │                        if free: ◄ prev                        │ ◄─┤ usize
 ├───────────────────────────────────────────────────────────────┤   │
 │                        if free: next ►                        │ ◄─┤
 ├───────────────────────────────────────────────────────────────┤   │
 │                             ...                               │   │ >= 0
 ├───────────────────────────────────────────────────────────────┤   │
 │                        if free: back ▲                        │ ◄─┘
 └───────────────────────────────────────────────────────────────┘ >= MIN SIZE
 F: FREE, L: LEFTFREE
 
 
 ╒═════════════════════ Root layout (32-bit) ════════════════════╕
    3                   2                   1
  1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0  bits
 ├─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┤          ┐
 │        0        |           flMap                            S│ ◄────┐
 ╞═══════════════════════════════════════════════════════════════╡      │
 │                           slMap[0] S                          │ ◄─┐  │
 ├───────────────────────────────────────────────────────────────┤   │  │
 │                           slMap[1]                            │ ◄─┤  │
 ├───────────────────────────────────────────────────────────────┤  uint32 │
 │                           slMap[22]                           │ ◄─┘  │
 ╞═══════════════════════════════════════════════════════════════╡    usize
 │                            head[0]                            │ ◄────┤
 ├───────────────────────────────────────────────────────────────┤      │
 │                              ...                              │ ◄────┤
 ├───────────────────────────────────────────────────────────────┤      │
 │                           head[367]                           │ ◄────┤
 ╞═══════════════════════════════════════════════════════════════╡      │
 │                             tail                              │ ◄────┘
 └───────────────────────────────────────────────────────────────┘   SIZE   ┘
 S: Small blocks map
 
                    [00]: < 256B (SB)  [12]: < 1M
                    [01]: < 512B       [13]: < 2M
                    [02]: < 1K         [14]: < 4M
                    [03]: < 2K         [15]: < 8M
                    [04]: < 4K         [16]: < 16M
                    [05]: < 8K         [17]: < 32M
                    [06]: < 16K        [18]: < 64M
                    [07]: < 32K        [19]: < 128M
                    [08]: < 64K        [20]: < 256M
                    [09]: < 128K       [21]: < 512M
                    [10]: < 256K       [22]: <= 1G - OVERHEAD
                    [11]: < 512K

WASM VMs limit to 2GB total (currently), making one 1G block max (or three 512M etc.) due to block overhead
```